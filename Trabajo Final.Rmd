---
title: "R Notebook"
output: html_notebook
---

PROPUESTA:
DESAGREGAR LA VARIACIÓN DE PRECIOS DE LAS PROPIEDADES INMOBILIARIAS DURANTE LA PANDEMIA EN UNA UNIDAD DE ANÁLISIS VIRTUAL (MALLA HEXAGONAL)

Construir una malla hexagonal que refleje: 
    1- promedio m2 en venta 01/03/2020 - 31/03/2020
    2- promedio m2 en venta 01/03/2021 - 31/03/2021
  
  Analizar la variación de precios.
  ¿Existe algún patrón espacial claro? 


Incorporar alguna otra variable que pueda llegar a explicarlo, como: 
    - distancia al centro
    - espacios verdes
    - densidad poblacional
    
¿Hay algún tipo de correlación? Estimar 



LIBRERIAS
vroom (cargar datos rapidos)
annotator (te da que hacer cada library)
skimr (analisis estadistico rapido) ---> skimr::skim(df)



Pasos principales para esta parte:

A) CREACIÓN DE HEXÁGONOS
  - explicación creación hexágonos (Unidad de análisis virtual)
  - Creación de la malla


B) DENSIDAD: 
  - Importar radios censales 
  - Graficar por barrios
  - Disolver por hexágonos


C) USOS (SI ALCANZA EL TIEMPO): 
  - Importar RUS (releva. usos del suelo)
  - Agrupar por 5/6 categorías
  - calcular centroides de las parcelas 
  - join espacial del centroide a la malla hexagonal
  - cual es el uso predominante del hexágono?
  
  
D) DATOS TERRENOS EN VENTA (BUENOS AIRES DATA)

  DATASET TERRENOS EN VENTA 2020 (TODO EL AÑO)
  DATASET TERRENOS EN VENTA (POSPANDEMIA: 2°, 3° Y 4° TRIMESTRE 2021)
  
  - exploración de datos (skim) + grafiquitos que pinten
  - limpieza de datos. Eliminar outliers (CREAR FUNCION PARA FILTRAR OUTLIERS?)
  
  Q1-1.5*IQR
  Q3+1.5*IQR
  
Q1=quantile(df$PRECIO, c(.25))
Q3=quantile(df$PRECIO, c(.75))
IQR= Q3-Q1

lim_inf=Q1-1.5*IQR
lim_sup=Q3+1.5*IQR
  
df_filter <- filter(df, PRECIO?? >lim_inf & precio_m2 < lim_sup)

Join espacial con HEXAGONOS 


crear objeto umbral:

umbral <- 4     
OJO: DETERMINAR UMBRAL. HEXÁGONOS CON MENOS INSTANCIAS QUE EL UMBRAL SE ELIMINAN/NO SE TIENEN EN CUENTA POR SESGO

Una vez que tenemos los hexágonos con 2 columnas: promedio Marzo 2020 y promedio Marzo 2021. 

mutate (VARIACION=marzo2021/marzo2020*100) 

GRAFICAR HEXÁGONOS CON PRECIOS 2020 Y 2021
GRAFICAR HEXÁGONOS CON VARIACIÓN 

INTERPRETAR


E) SI SOBRA TIEMPO, VER CORRELACIÓN. .corr (?)

 
  
  
```{r message=FALSE, warning=FALSE}
library(sf)
library(tidyverse)
library(ggplot2)
library(skimr)
library(annotater)
library(sp) #??
library(rgeos) #??
library(osmdata) 
```

```{r}
barrios_CABA <- st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/barrios/barrios.geojson") %>% 
  select() %>% 
  st_transform(crs = 4326)
```

```{r}
grid <- st_make_grid(barrios_CABA, cellsize = .01, what = "polygons", square = FALSE)

grid <- st_sf(index = 1:length(lengths(grid)), grid) %>%  #le agregamos un índice
  st_transform(crs = 4326)
```


```{r}
bbox_CABA_limite <- getbb("Ciudad Autónoma de Buenos Aires, Argentina", format_out = "sf_polygon")
bbox_CABA_limite <- bbox_CABA_limite$multipolygon
```


```{r}
hex <- st_intersection(grid, bbox_CABA_limite)
```


```{r}
ggplot()+
  geom_sf(data = barrios_CABA, fill="lightgray", size=.8) + 
  geom_sf(data=hex, fill=NA, color="brown4")+
  theme_void()
```

```{r}
radios <- st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/informacion-censal-por-radio/caba_radios_censales.geojson") %>% 
  select(-WKT) %>% 
  st_transform(crs = 4326) %>% 
  mutate(AREA=(as.integer(st_area(.)))*0.0001) %>% #multriplicamos para convertir de m2 a ha
  mutate(DENSIDAD=(as.integer(TOTAL_POB))/AREA)
```

```{r}
ggplot()+
  geom_sf(data=radios, aes(fill=DENSIDAD), color=NA)+
  geom_sf(data = barrios_CABA, fill=NA, size=.8) + 
  geom_sf(data=hex, fill=NA, color="white")+
  scale_fill_viridis_c()+
  theme_void()
```



```{r}
hex2 <- st_centroid(radios) %>% st_join(hex)
```


```{r}
ggplot()+
  geom_sf(data=hex) +
  geom_sf(data=hex2, aes(color=DENSIDAD))+
  scale_color_viridis_c()+
  theme_void()
```
```{r}
hex3 <- hex2 %>% 
  group_by(index) %>% 
  summarise(PROM_DENS=mean(DENSIDAD), INSTANCIAS=n()) %>% 
  as.data.frame() %>% 
  select(-geometry)
```

```{r}
hex_densidad <- left_join(hex3, hex, by="index")
```

```{r}
ggplot()+
  geom_sf(data=barrios_CABA, fill="lightgray") +
  geom_sf(data=hex_densidad, aes(fill=PROM_DENS, geometry = grid))+
  geom_sf(data=hex_densidad %>% filter(INSTANCIAS<=4), aes(geometry = grid), fill="red")+
  scale_fill_viridis_c() +
  theme_void()
```
 
 
