---
title: "R Notebook"
output: html_notebook
---

PROPUESTA:
DESAGREGAR LA VARIACIÓN DE PRECIOS DE LAS PROPIEDADES INMOBILIARIAS DURANTE LA PANDEMIA EN UNA UNIDAD DE ANÁLISIS VIRTUAL (MALLA HEXAGONAL)

Construir una malla hexagonal que refleje: 
    1- promedio m2 en venta 01/03/2020 - 31/03/2020
    2- promedio m2 en venta 01/03/2021 - 31/03/2021
  
  Analizar la variación de precios.
  ¿Existe algún patrón espacial claro? 


Incorporar alguna otra variable que pueda llegar a explicarlo, como: 
    - distancia al centro
    - espacios verdes
    - densidad poblacional
    
¿Hay algún tipo de correlación? Estimar 



Pasos principales para esta parte:

A) importar, explorar y limpiar los datos de propiedades inmobiliarias. Eliminar outliers (ver formula).
Gráficos de barra y mapita por barrio que luego vamos a desagregar en hexágonos. ¿algo llamativo?

REPETIR PARA MARZO 2021 (ideal: crear una función que automatice alguno de los pasos)


B) construir la malla de hexágonos, con ID por polígono. Definir tamaño. 
  St_join() para vincular las propieadades a los hexágonos. 
  OJO: ¿qué pasa con los hexágonos que tienen 1 sola propiedad? hay que checkear que sea un valor representativo     porque sino sesgaría fuerte
  OJO2: hexágonos que en alguno de los 2 períodos no registren valores, se van a temrinar eliminando de la           comparación final


C) analizar cómo varió cada uno de los hexágonos. Calcular el % de variación y hacer mapita.
  incoporar alguna otra variable y ver si hay correlación con eso. 
  
  
  
```{r message=FALSE, warning=FALSE}
library(sf)
library(tidyverse)
library(ggplot2)
library(skimr)
library(annotater)
library(sp)
library(rgeos)
library(osmdata)
```

```{r}
dptos_venta <- read.csv("data/ar_properties.csv")
barrios_CABA <- st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/barrios/barrios.geojson") %>% 
  select() %>% 
  st_transform(crs = 4326)
```

```{r}
grid <- st_make_grid(barrios_CABA, cellsize = .01, what = "polygons", square = FALSE)

grid <- st_sf(index = 1:length(lengths(grid)), grid) %>%  #le agregamos un índice
  st_transform(crs = 4326)
```

```{r}
bbox_CABA_limite <- getbb("Ciudad Autónoma de Buenos Aires, Argentina", format_out = "sf_polygon")
bbox_CABA_limite <- bbox_CABA_limite$multipolygon
```


```{r}
hex <- st_intersection(grid, bbox_CABA_limite)
```


```{r}
ggplot()+
  geom_sf(data = barrios_CABA, fill="lightgray", size=.8) + 
  geom_sf(data=hex, fill=NA, color="brown4")+
  theme_void()
```

```{r}
radios <- st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/informacion-censal-por-radio/caba_radios_censales.geojson") %>% 
  select(-WKT) %>% 
  st_transform(crs = 4326) %>% 
  mutate(AREA=as.numeric(st_area(.))) %>%
  mutate(DENSIDAD=(as.numeric(TOTAL_POB))/AREA)
```

```{r}
ggplot()+
  geom_sf(data=radios, aes(fill=DENSIDAD), color=NA)+
  geom_sf(data = barrios_CABA, fill=NA, size=.8) + 
  geom_sf(data=hex, fill=NA, color="white")+
  scale_fill_viridis_c()+
  theme_void()
```



```{r}
hex2 <- st_centroid(radios) %>% st_join(hex)
```


```{r}
ggplot()+
  geom_sf(data=hex) +
  geom_sf(data=hex2, aes(color=DENSIDAD))+
  scale_color_viridis_c()+
  theme_void()
```
```{r}
hex3 <- hex2 %>% 
  group_by(index) %>% 
  summarise(PROM_DENS=mean(DENSIDAD)) %>% 
  as.data.frame() %>% 
  select(-geometry)
```

```{r}
hex_densidad <- left_join(hex3, hex, by="index")
```

```{r}
ggplot()+
  geom_sf(data=barrios_CABA, fill=NA) +
  geom_sf(data=hex_densidad, aes(fill=PROM_DENS, geometry = grid))+
  scale_fill_viridis_c() +
  theme_void()
```
 
 
